{% extends 'destinations/base.html' %}

{% block content %}
    <div id="destination-edit">
        <!-- Destination edit form will be loaded here by JavaScript -->
        <p>Loading destination data...</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const destinationId = {{ destination_id }};

            // First, fetch the existing destination data
            fetch(/api/destinations/${destinationId}/)
                .then(response => response.json())
                .then(destination => {
                    const container = document.getElementById('destination-edit');

                    let imagesHtml = '<div class="image-gallery">';
                    destination.images.forEach(image => {
                        imagesHtml += `
                            <div>
                                <img src="${image.image}" alt="Destination image">
                                <button onclick="deleteImage(${image.id})" class="btn" style="background: #e8491d; width: 100%;">Delete</button>
                            </div>
                        `;
                    });
                    imagesHtml += '</div>';

                    const html = `
                        <h2>Edit Tourist Destination</h2>
                        <div class="card">
                            <form id="destination-form" enctype="multipart/form-data">
                                <div class="form-group">
                                    <label for="place_name">Place Name:</label>
                                    <input type="text" id="place_name" name="place_name" value="${destination.place_name}" required>
                                    <div id="place_name_error" class="error"></div>
                                </div>

                                <div class="form-group">
                                    <label for="weather">Weather:</label>
                                    <input type="text" id="weather" name="weather" value="${destination.weather}" required>
                                    <div id="weather_error" class="error"></div>
                                </div>

                                <div class="form-group">
                                    <label for="state">State:</label>
                                    <input type="text" id="state" name="state" value="${destination.state}" required>
                                    <div id="state_error" class="error"></div>
                                </div>

                                <div class="form-group">
                                    <label for="district">District:</label>
                                    <input type="text" id="district" name="district" value="${destination.district}" required>
                                    <div id="district_error" class="error"></div>
                                </div>

                                <div class="form-group">
                                    <label for="description">Description:</label>
                                    <textarea id="description" name="description" rows="5" required>${destination.description}</textarea>
                                    <div id="description_error" class="error"></div>
                                </div>

                                <div class="form-group">
                                    <label for="images">Add More Images:</label>
                                    <input type="file" id="images" name="images" multiple accept="image/*">
                                    <div id="images_error" class="error"></div>
                                </div>

                                <h3>Existing Images</h3>
                                ${imagesHtml}

                                <button type="submit" class="btn">Update Destination</button>
                                <a href="/${destination.id}/" class="btn" style="background: #ccc;">Cancel</a>
                            </form>
                        </div>
                    `;

                    container.innerHTML = html;

                    // Set up form submission
                    document.getElementById('destination-form').addEventListener('submit', function(e) {
                        e.preventDefault();

                        // Clear previous errors
                        document.querySelectorAll('.error').forEach(el => el.textContent = '');

                        const formData = new FormData();
                        formData.append('place_name', document.getElementById('place_name').value);
                        formData.append('weather', document.getElementById('weather').value);
                        formData.append('state', document.getElementById('state').value);
                        formData.append('district', document.getElementById('district').value);
                        formData.append('description', document.getElementById('description').value);

                        const imageFiles = document.getElementById('images').files;
                        for (let i = 0; i < imageFiles.length; i++) {
                            formData.append('uploaded_images', imageFiles[i]);
                        }

                        fetch(/api/destinations/${destinationId}/, {
                            method: 'PUT',
                            body: formData,
                            headers: {
                                'X-CSRFToken': csrftoken
                            }
                        })
                        .then(response => response.json().then(data => {
                            if (response.ok) {
                                window.location.href = /${destinationId}/;
                            } else {
                                // Display validation errors
                                for (const field in data) {
                                    const errorElement = document.getElementById(${field}_error);
                                    if (errorElement) {
                                        errorElement.textContent = data[field].join(' ');
                                    }
                                }
                            }
                        }))
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred. Please try again.');
                        });
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('destination-edit').innerHTML =
                        '<p>Error loading destination data. Please try again later.</p>';
                });
        });

        function deleteImage(imageId) {
            if (confirm('Are you sure you want to delete this image?')) {
                fetch(/api/images/${imageId}/, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Error deleting image');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting image');
                });
            }
        }
    </script>
{% endblock %}